# Проектная работа: Биллинг

## Задание
Нужно сделать два метода работы с картами: оплатить подписку и вернуть за неё деньги.

При этом система должна быть устойчивой к перебоям: не должно происходить двойных списаний, 
и чтобы у пользователя всегда была гарантия, что операция выполнилась. 

Помимо реализации системы, интегрируйте эту систему с админкой Django, 
чтобы вы могли контролировать оплату подписок клиентами.


## Исходные данные и ограничения
* MAU кинотеатра 1 000 000 пользователей
* Пользовательская база всего 5 000 000 пользователей

## Сервис подписок
### Функциональные требования:
* хранить информацию о типах подписок:
  * название
  * текстовое описание
  * стоимость в месяц
  * стоимость за год
  * начало продаж
  * завершение продаж
* хранить информацию о подписках пользователя:
  * тип подписки
  * начало срока действия
  * окончание срока действия
  * статус (действительна, ожидает оплаты, завершена)
  * id способа оплаты (для рекуррентных платежей)
* проверять истекающие подписки и формирует запрос на оплату в сервис биллинга
* По пользовательскому API:
   * возвращать информацию о подписках пользователя
   * возвращать список доступных для покупки подписок
   * оформлять подписку
   * отменять подписку
   * оформлять оплату подписки и отправлять запрос на оплату в сервис биллинга и возвращать ссылку на оплату
   * оформлять возврат денег за подписку отправлять запрос на возврат в сервис биллинга и возвращать ссылку на возврат
* По внутреннему API:
   * CRUD типов подписок для администратора
   * принимать информацию, что подписка оплачена/деньги за подписку возвращены
* Отправлять по email уведомления:
   * подписка оформлена/активирована/продлена
   * подписка отменена
   * запланирована оплата через N дней
### Нефункциональные требования:
* Нагрузка на Пользовательский API
  * Пользователи оформляют, просматривают или отменяют подписку 20% от MAU кинотеатра за месяц, т.е. MAU 200 000
  * DAU = 200 000 / 30 = 6 664 в день 
  * Среднее число операций за посещение 5
  * Операций в день = 6 664 * 5 = 33 320
  * 33 320 / 24 / 60 = 23.14 RPM
  * Пик 80% за 20% времени = 33 320 / 24 / 60 * (0.8 / 0,2) = 23.14 * 4 = 92.5 RPM
* Нагрузка на Внутренний API
  * К сервису Подписок обращается сервис Auth при формировании Access-токена
  * При прогретом кэше, сервис Auth запрашивает Подписки 1 раз в сутки
    * DAU = 1 000 000 / 30 = 33 333 в день, число операций 1
    * 33 333 / 24 / 60 = 23.2 RPM в среднем
    * Пик 80% за 20% времени = 23.2 * 4 = 93 RPM пик
  * При пустом кэше, сервис Auth запрашивает Подписки 80 за 20:
    * DAU = 1 000 000 / 30 * 4 = 133 333 в день, число операций 1
    * 133 333 / 24 / 60 = 92.6 RPM в среднем = 1.54 PRS
    * Пик 80% за 20% времени = 92.6 * 4 = 370 RPM пик = 6.2 RPS
* Нагрузка планировщика 
* Итого нагрузка:
  * в среднем = 23.2 + 23.2 = 46.4 RPM
  * пик = 23 + 370 = 393 RMM (6.55 RPS)
* Хранилище
  * 5 млн пользователей * 1.2 подписки = 6 млн подписок
  * 6 млн подписок * 64..100 байт = 0.34..1 ГБ
  * типы подписок не учитываем
  * для надёжности хранения нужно реплицирование с быстрым переключением в случае выхода из строя мастер ноды
* Безопасность:
  * API Auth должен аутентифицировать пользователя на запросы к API Подписок


## Сервис биллинга
### Функциональные требования:
* Проводить оплату за подписку через ЮКасса:
   * Первичную оплату подписки. В процессе первичной оплаты на стороне ЮКассы создается возможность автоплатежа.
   * Сервис с заданной периодичность осуществляет оплату продления подписки.
   * Сервис хранит историю платежей пользователя, включая id способа оплаты и id платежа.
   * Сервис должен уметь проводить возврат полный в течении первой недели или частичный пропорционально времени использования.
* Хранить информацию о платежах:
  * ID пользователя
  * дата-время платежа
  * сумма
  * ID подписки
* Предоставлять пользовательский API с методами:
   * возвращать информацию о платежах:
* Предоставлять внутренний API с методами:
   * проведения продления подписки
   * по запросу с параметрами оплаты возвращает ссылку на оплату
   * по callback получает информацию о результате проведения платежа и передает в сервис подписок
   * по запросу с параметрами возврата возвращает ссылку на возврат
   * по callback получает информацию о результате проведения возврата и передает в сервис подписок
* Отправлять по email уведомления:
   * платеж за подписку успешно прошел
   * об ошибках оплаты подписки
### Нефункциональные требования:
* Нагрузка на Пользовательский API
  * К сервису Биллинга обращается сервис Подписок для оплаты, продления или отмены оплаты подписки
  * Число обращений 15% от MAU кинотеатра за месяц, т.е. MAU 150 000
  * DAU = 150 000 / 30 = 5 000 в день 
  * Среднее число операций за посещение 5
  * Операций в день = 5 000 * 5 = 25 000
  * 25 000 / 24 / 60 = 17.36 RPM
  * Пик 80% за 20% времени = 17.36 * 4 = 69 RPM
* Нагрузка на Внутренний API
  * К сервису Биллинга обращается сервис Подписок для оплаты, продления или отмены оплаты подписки
  * Число обращений 15% от MAU кинотеатра за месяц, т.е. MAU 150 000
  * DAU = 150 000 / 30 = 5 000 в день 
  * Среднее число операций за посещение 5
  * Операций в день = 5 000 * 5 = 25 000
  * 25 000 / 24 / 60 = 17.36 RPM
  * Пик 80% за 20% времени = 17.36 * 4 = 69 RPM
* Хранилище
  * Новые записи производятся при каждой оплате, отмене и продлении
  * Число платящих каждый месяц пользователей 2 000 000
  * Число пользователей в месяц 
    * оплата новых подписок 15% от MAU в месяц = 150 000
    * продление ежемесячных 30% от платящих = 2 000 000 * 0,3 = 600 000 
    * продление годовых 70% от платящих = 2 000 000 * 0,7 в год = 1 400 000 или 116 667
    * отмена от оплаты 7% от MAU в месяц = 70 000 
    * итого в месяц 836.667 новых записей в месяц
    * за год 10 040 000 * 44 байт = 442 ГБ за год
* Безопасность:
  * Только внутренние запросы


## Сервис Auth
### Функциональные требования:
* запрашивает на сервисе подписок и кэширует информацию об активных подписках пользователя.
* помещает информацию об активных подписках в JWT-токен


## Дополнительно
* Посчитать сколько подписок влезает в JWT-токен