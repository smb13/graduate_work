# Проектная работа: Биллинг

Нужно сделать два метода работы с картами: оплатить подписку и вернуть за неё деньги. 
При этом система должна быть устойчивой к перебоям: не должно происходить двойных списаний, 
и чтобы у пользователя всегда была гарантия, что операция выполнилась. 
Помимо реализации системы, интегрируйте эту систему с админкой Django, 
чтобы вы могли контролировать оплату подписок клиентами.

## Функциональные требования:
1. Сервис биллинга должен уметь проводить оплату за подписку через ЮКасса:
   * Первичную оплату подписки. В процессе первичной оплаты на стороне ЮКассы создается возможность автоплатежа.
   * Сервис с заданной периодичность осуществляет оплату продления подписки.
   * Сервис хранит историю платежей пользователя, включая id способа оплаты и id платежа.
   * Сервис должен уметь проводить возврат полный в течении первой недели или частичный пропорционально времени использования.
2. Сервис биллинга должен предоставлять пользовательский API с методами:
   * возвращать информацию о платежах:
3. Сервис биллинга должен предоставлять внутренний API с методами:
   * проведения продления подписки
   * по запросу с параметрами оплаты возвращает ссылку на оплату
   * по callback получает информацию о результате проведения платежа и передает в сервис подписок
   * по запросу с параметрами возврата возвращает ссылку на возврат
   * по callback получает информацию о результате проведения возврата и передает в сервис подписок
4. Сервис биллинга должен отправлять по email уведомления:
   * платеж за подписку успешно прошел
   * об ошибках оплаты подписки
5. Сервис подписок:
   * хранит информацию о подписках пользователя, включая сроки действия и сохраненного id способа оплаты
   * проверят истекающие подписки и формирует запрос на оплату в сервис биллинга
   * хранит информацию о типах подписок, описанию и стоимость
6. Сервис подписок должен по пользовательскому API:
   * возвращать информацию о подписках пользователя
   * возвращать список доступных для покупки подписок
   * оформлять подписку
   * отменять подписку
   * оформлять оплату подписки и отправлять запрос на оплату в сервис биллинга и возвращать ссылку на оплату
   * оформлять возврат денег за подписку отправлять запрос на возврат в сервис биллинга и возвращать ссылку на возврат
7. Сервис подписок должен по внутреннему API:
   * CRUD типов подписок для администратора
   * принимать информацию, что подписка оплачена/деньги за подписку возвращены
8. Сервис подписок должен отправлять по email уведомления:
   * подписка оформлена/активирована/продлена
   * подписка отменена
   * запланирована оплата через N дней
9. Сервис Auth
   * запрашивает на сервисе подписок и кэширует информацию об активных подписках пользователя.
   * помещает информацию об активных подписках в JWT-токен
 
- Сервис получает информацию о подписках пользователя, стоимости каждого типа подписки из 

- Посчитать сколько подписок влезает в JWT-токен


## Нефункциональные требования:
#### Пользовательский API:
1. Нагрузка
  * MAU кинотеатра 1 000 000 пользователей
  * Из их в биллинг заходит 5% в месяц = 50 000, в день  
  * 5 операций в день = 2 700 * 5 млн в день
  * Пик 80% за 20% времени = 1,8 млн / (24*60*60*0,2) = 1 800 000 / 17 280 = 104 RPS уведомлений в секунду
2. Хранилище
  * 2 млн уведомлений * 30 дней = 60 млн записей
  * 2 млн уведомлений * 30 дней * 1..10 кб = 60..600 ГБ
  * Не нужны констрейнты на связи с другими таблицами
  * Нужно масштабирование на случай возрастания объёма данных
  * Хранилище пользователей 1 000 000 * 1 кб = 1 ГБ
3. Безопасность:
  * API пользователей должен аутентифицировать пользователя, при этом мы можем его персональные данные запрашивать
    в сервисе Auth по API в этот же момент и сохранять обновлять их у себя в БД